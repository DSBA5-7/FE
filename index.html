<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>CreditNews</title>
</head>
<body>
    <header>
        <a href="index.html">
            <p style="font-size: 30px; font-weight: bold; margin: 0; color: white;">CNS</p>
        </a>
    </header>
    <div class="container">
        <h1>CreditNews</h1>
        <div class="input-group">
            <input type="text" id="detailed-address" placeholder="URL 입력">
            <button id="search-button">Search</button>
        </div>
    </div>
    <div id="results" class="container" style="display: none;">
        <h1>신뢰도: <span id="credibility"></span>%</h1>
        <p id="result"></p>
        <ul id="related-articles"></ul>
    </div>

    <script>
        // URL 유효성 검사 함수
        function isValidURL(url) {
            const pattern = /^(https?:\/\/)?([\w\-]+(\.[\w\-]+)+)(\/[\w\-._~:/?#[\]@!$&'()*+,;=]*)?$/;
            return pattern.test(url);
        }
    
        // Flask API에서 뉴스 데이터 가져오기
        async function fetchNewsData(url) {
            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: url }) // URL 데이터 전송
                });
                if (!response.ok) {
                    throw new Error('데이터를 불러오는 데 실패했습니다.');
                }
                const newsData = await response.json();
                return newsData;
            } catch (error) {
                console.error('데이터 로드 오류:', error);
                return null;
            }
        }
    
        document.addEventListener('DOMContentLoaded', function () {
            const searchButton = document.getElementById('search-button');
            searchButton.onclick = async function () {
                const address = document.getElementById('detailed-address').value;
                const resultDiv = document.getElementById('results');
                const relatedArticlesList = document.getElementById('related-articles');
                const credibilitySpan = document.getElementById('credibility');
    
                // URL 유효성 검사
                if (!isValidURL(address)) {
                    alert("유효한 URL을 입력하세요.");
                    return;
                }
    
                // API 호출 및 데이터 처리
                const newsData = await fetchNewsData(address);
                if (!newsData) {
                    alert("뉴스 데이터를 불러오는 데 실패했습니다.");
                    return;
                }
    
                // 신뢰도 데이터 표시
                const credibility = newsData.credibility || 0;
                credibilitySpan.textContent = credibility;
    
                // 관련 기사 목록 표시
                relatedArticlesList.innerHTML = ""; // 기존 내용 삭제
                const similarArticles = newsData.similar_articles || [];
                similarArticles.forEach(article => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <h3>${article.title}</h3>
                        <p>유사도: ${article.similarity}%</p>
                        <p>감정 분석: ${article.emotion}</p>
                        <a href="${article.url}" target="_blank">기사 링크</a>
                    `;
                    relatedArticlesList.appendChild(listItem);
                });
    
                // 결과 화면 표시
                resultDiv.style.display = "block";
            };
        });
    </script>    
</body>
</html>